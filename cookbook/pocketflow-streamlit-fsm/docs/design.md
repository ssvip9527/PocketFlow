# è®¾è®¡æ–‡æ¡£: PocketFlow Streamlit å›¾åƒç”Ÿæˆ HITL

> ä½¿ç”¨ PocketFlow å’Œ Streamlit çš„äººæœºåä½œå›¾åƒç”Ÿæˆåº”ç”¨

## éœ€æ±‚

**ç”¨æˆ·æ•…äº‹**ï¼šä½œä¸ºç”¨æˆ·ï¼Œæˆ‘å¸Œæœ›ï¼š
1. è¾“å…¥ä¸€ä¸ªæè¿°æˆ‘æƒ³è¦ç”Ÿæˆçš„å›¾åƒçš„æ–‡æœ¬æç¤º
2. ç³»ç»Ÿæ ¹æ®æˆ‘çš„æç¤ºä½¿ç”¨ OpenAI çš„å›¾åƒç”Ÿæˆ API ç”Ÿæˆå›¾åƒ
3. åœ¨ç½‘é¡µç•Œé¢ä¸­å®¡æŸ¥ç”Ÿæˆçš„å›¾åƒ
4. å¦‚æœæ»¡æ„åˆ™æ‰¹å‡†å›¾åƒï¼Œæˆ–è€…å¦‚æœæƒ³è¦ä¸åŒçš„ç»“æœåˆ™ä½¿ç”¨ç›¸åŒçš„æç¤ºé‡æ–°ç”Ÿæˆ
5. å°†æœ€ç»ˆæ‰¹å‡†çš„å›¾åƒä½œä¸ºå®Œæˆçš„ç»“æœ

**æŠ€æœ¯è¦æ±‚**ï¼š
- ä½¿ç”¨ OpenAI çš„å›¾åƒç”Ÿæˆ APIï¼ˆé€šè¿‡ `responses.create` ä¸ `image_generation` å·¥å…·ï¼‰
- å°†ç”Ÿæˆçš„å›¾åƒä¿å­˜åœ¨å†…å­˜ä¸­ï¼ˆbase64 æ ¼å¼ï¼‰- ä¸è¿›è¡Œç£ç›˜å­˜å‚¨
- æä¾›æ¸…æ™°çš„æ‰¹å‡†/é‡æ–°ç”Ÿæˆå·¥ä½œæµç¨‹
- ä¼˜é›…åœ°å¤„ç† API é”™è¯¯å¹¶è¿›è¡Œé‡è¯•
- åœ¨ç”Ÿæˆä¹‹é—´ç»´æŠ¤ä¼šè¯çŠ¶æ€

## æµç¨‹è®¾è®¡

### é€‚ç”¨è®¾è®¡æ¨¡å¼ï¼š

**å¸¦æœ‰å¤šå­æµçš„çŠ¶æ€æœº**ï¼šæ¯ä¸ªçŠ¶æ€éƒ½æœ‰è‡ªå·±çš„ç”¨æˆ·ç•Œé¢å’Œå·¥ä½œæµç¨‹ã€‚ç”¨æˆ·åœ¨æ¯ä¸ªçŠ¶æ€ä¸­ä¸ä¸åŒçš„ UI å…ƒç´ äº¤äº’ï¼Œåº”ç”¨ç¨‹åºæ ¹æ®ç”¨æˆ·æ“ä½œå’Œåé¦ˆè½¬æ¢åˆ°ä¸‹ä¸€ä¸ªçŠ¶æ€ã€‚

### çŠ¶æ€ä¸ç”¨æˆ·ç•Œé¢ï¼š

1. **initial_input** - ç”¨æˆ·çœ‹åˆ°æ–‡æœ¬è¾“å…¥å­—æ®µï¼Œè¾“å…¥æç¤ºï¼Œç‚¹å‡»â€œç”Ÿæˆå›¾åƒâ€æŒ‰é’®
2. **user_feedback** - ç”¨æˆ·çœ‹åˆ°ç”Ÿæˆçš„å›¾åƒï¼Œæœ‰â€œæ‰¹å‡†â€å’Œâ€œé‡æ–°ç”Ÿæˆâ€æŒ‰é’®
3. **final** - ç”¨æˆ·çœ‹åˆ°æœ€ç»ˆæ‰¹å‡†çš„å›¾åƒå’Œâ€œé‡æ–°å¼€å§‹â€æŒ‰é’®

### æµç¨‹é«˜çº§è®¾è®¡ä¸è½¬æ¢ï¼š

```mermaid
flowchart TD
    Start([å¼€å§‹]) --> IS[åˆå§‹è¾“å…¥]
    IS --> GI[ç”Ÿæˆå›¾åƒ]
    GI --> UF[ç”¨æˆ·åé¦ˆ]
    UF -->|é‡æ–°ç”Ÿæˆ| GI
    UF -->|æ‰¹å‡†| F[æœ€ç»ˆ]
    F --> IS
    
    %% å›¾ä¾‹
    classDef stateStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef nodeStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px
    
    class IS,UF,F stateStyle
    class GI nodeStyle
```

**å›¾ä¾‹**ï¼š
- ğŸ”· **è“è‰²çŸ©å½¢**ï¼šç”¨æˆ·ç•Œé¢çŠ¶æ€ï¼ˆåˆå§‹è¾“å…¥ã€ç”¨æˆ·åé¦ˆã€æœ€ç»ˆï¼‰
- ğŸ”¶ **æ©™è‰²çŸ©å½¢**ï¼šPocketFlow å¤„ç†èŠ‚ç‚¹ï¼ˆç”Ÿæˆå›¾åƒï¼‰

## å®ç”¨åŠŸèƒ½

1. **ç”Ÿæˆå›¾åƒ** (`utils/generate_image.py`)
   - *è¾“å…¥*ï¼šæç¤º (str)
   - *è¾“å‡º*ï¼šbase64 å›¾åƒæ•°æ® (str)
   - *ç›®çš„*ï¼šè°ƒç”¨ OpenAI çš„å›¾åƒç”Ÿæˆ API å¹¶è¿”å› base64 ç¼–ç çš„å›¾åƒ
   - *é”™è¯¯å¤„ç†*ï¼šåŒ…å« API å¤±è´¥çš„é‡è¯•é€»è¾‘

## èŠ‚ç‚¹è®¾è®¡

### å…±äº«å†…å­˜

**ä½¿ç”¨ Streamlit ä¼šè¯çŠ¶æ€ä½œä¸ºå…±äº«å­˜å‚¨**ï¼šæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ `st.session_state` ä½œä¸º PocketFlow çš„å…±äº«å­˜å‚¨ï¼Œæ— éœ€å•ç‹¬çš„æ•°æ®ç»“æ„ã€‚

å›¾åƒç”Ÿæˆå·¥ä½œæµç¨‹çš„ä¼šè¯çŠ¶æ€ç»“æ„ï¼š

```python
st.session_state = {
    # ç”¨æˆ·è¾“å…¥å’Œå·¥ä½œæµçŠ¶æ€
    "task_input": "ç”¨æˆ·ç”¨äºå›¾åƒç”Ÿæˆçš„æ–‡æœ¬æç¤º",
    "stage": "å½“å‰å·¥ä½œæµé˜¶æ®µ (initial_input/user_feedback/final)",
    "error_message": "ç”¨äºç”¨æˆ·åé¦ˆçš„ä»»ä½•é”™è¯¯æ¶ˆæ¯",
    
    # å¤„ç†æ•°æ®
    "input_used_by_process": "ç”¨äºç”Ÿæˆçš„æç¤º",
    "generated_image": "base64 ç¼–ç çš„å›¾åƒæ•°æ®",
    "final_result": "æœ€ç»ˆæ‰¹å‡†çš„å›¾åƒæ•°æ®",
    
    # Streamlit å†…ç½®é”®ï¼ˆè‡ªåŠ¨ç®¡ç†ï¼‰
    # "_streamlit_*": å„ç§å†…éƒ¨ streamlit çŠ¶æ€
}
```

### èŠ‚ç‚¹æ­¥éª¤

**åˆå§‹è¾“å…¥æµç¨‹èŠ‚ç‚¹**ï¼š

1. **å›¾åƒç”ŸæˆèŠ‚ç‚¹**
   - *ç›®çš„*ï¼šæ ¹æ®æç¤ºä½¿ç”¨ OpenAI API ç”Ÿæˆå›¾åƒ
   - *ç±»å‹*ï¼šå¸¸è§„ï¼ˆå¸¦é‡è¯•ä»¥æé«˜ API å¯é æ€§ï¼‰
   - *æ­¥éª¤*ï¼š
     - *prep*ï¼šä» `st.session_state` è¯»å– "input_used_by_process"
     - *exec*ï¼šä½¿ç”¨æç¤ºè°ƒç”¨ `generate_image` å®ç”¨ç¨‹åºï¼Œè¿”å› base64 å›¾åƒæ•°æ®
     - *post*ï¼šå°† base64 å›¾åƒæ•°æ®å†™å…¥ `st.session_state` ä¸­çš„ "generated_image"

**ç”¨æˆ·åé¦ˆæµç¨‹**ï¼š
- å½“ç”¨æˆ·ç‚¹å‡»â€œé‡æ–°ç”Ÿæˆâ€æ—¶ï¼Œé‡ç”¨ç›¸åŒçš„ `GenerateImage` èŠ‚ç‚¹

**æœ€ç»ˆæµç¨‹**ï¼š
- ä¸éœ€è¦å¤„ç†èŠ‚ç‚¹ - `final` çŠ¶æ€åªæ˜¾ç¤º `generated_image` ä¸­æ‰¹å‡†çš„å›¾åƒï¼Œå¹¶æä¾›é‡æ–°å¼€å§‹çš„ UI
